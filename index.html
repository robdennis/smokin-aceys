<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Game Strategy Simulator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js for charting -->
    <script src="https://cdn.plot.ly/plotly-2.33.0.min.js"></script>
    <style>
        /* Custom styles for better UX */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light text */
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        input, select {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 100%;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e40af;
        }
        details > summary {
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 600;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        details > summary:hover {
            background-color: #374151;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Card Game Strategy Simulator</h1>
            <p class="text-lg text-gray-400 mt-2">Model and analyze betting strategies for the 'Between the Sheets' card game.</p>
        </header>

        <div id="main-grid" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Panel: Configuration -->
            <div id="config-panel" class="lg:col-span-1 flex flex-col gap-8">
                <!-- Game Settings -->
                <div id="game-settings-card" class="card">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">Game Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="ante-amount" class="block font-medium mb-1">Ante Amount ($)</label>
                            <input type="number" id="ante-amount" value="0.20" min="0.01" step="0.01">
                        </div>
                        <div>
                            <label for="starting-pot" class="block font-medium mb-1">Extra Starting Pot ($)</label>
                            <input type="number" id="starting-pot" value="0" min="0" step="0.01">
                        </div>
                        <h3 class="font-bold pt-2">Game End Conditions</h3>
                        <div>
                            <label for="min-total-bets" class="block font-medium mb-1">Min Total Bets Made</label>
                            <input type="number" id="min-total-bets" value="6" min="1">
                        </div>
                        <div>
                            <label for="min-pot-clear-value" class="block font-medium mb-1">Min Pot Size on Clear ($)</label>
                            <input type="number" id="min-pot-clear-value" value="2" min="0" step="0.01">
                        </div>
                        <div class="pt-2">
                             <label class="flex items-center">
                                <input type="checkbox" id="show-live-deck" class="w-auto mr-2">
                                Show Live Deck
                            </label>
                             <label class="flex items-center mt-1">
                                <input type="checkbox" id="show-live-turn" class="w-auto mr-2" checked>
                                Show Live Turn Details
                            </label>
                        </div>
                        <div class="flex gap-4 pt-4">
                             <button id="import-config-btn" class="btn btn-secondary flex-1">Import Config</button>
                             <button id="export-config-btn" class="btn btn-secondary flex-1">Export Config</button>
                             <input type="file" id="import-file-input" class="hidden" accept=".json">
                        </div>
                    </div>
                </div>

                <!-- Players -->
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">Players</h2>
                    <div id="player-list" class="space-y-3"></div>
                    <button id="add-player-btn" class="btn btn-primary w-full mt-4">Add New Player</button>
                </div>
            </div>

            <!-- Right Panel: Simulation & Results -->
            <div id="results-panel" class="lg:col-span-2 flex flex-col gap-8">
                <!-- Simulation Controls -->
                <div class="card">
                     <h2 class="text-2xl font-bold mb-2 border-b border-gray-600 pb-2">Simulation Controls</h2>
                     <div class="flex flex-col md:flex-row gap-2 items-center">
                        <div class="w-full md:w-auto flex-grow">
                             <label for="simulation-count" class="block font-medium mb-1">Number of Games to Simulate</label>
                             <input type="number" id="simulation-count" value="100" min="1" class="w-full">
                        </div>
                        <div class="w-full md:w-auto pt-0 md:pt-7">
                            <button id="start-simulation-btn" class="btn btn-primary w-full">Start Simulation</button>
                        </div>
                        <div class="w-full md:w-auto pt-0 md:pt-7">
                             <button id="stop-simulation-btn" class="btn btn-danger w-full" disabled>Stop Simulation</button>
                        </div>
                        <div class="w-full md:w-auto pt-0 md:pt-7">
                            <label class="flex items-center">
                               <input type="checkbox" id="halt-simulation-checkbox" class="w-auto mr-2">
                               Halt Simulation
                           </label>
                       </div>
                        <div id="next-turn-btn-container" class="w-full md:w-auto pt-0 md:pt-7 hidden">
                           <button id="next-turn-btn" class="btn btn-secondary w-full">Next Turn</button>
                        </div>
                        <div id="toggle-config-btn-container" class="w-full md:w-auto pt-0 md:pt-7 hidden">
                            <button id="toggle-config-btn" class="btn btn-secondary w-full">Show Config</button>
                        </div>
                     </div>
                     <div id="progress-container" class="mt-2 hidden">
                        <div class="flex justify-between mb-1">
                            <span id="progress-text" class="text-base font-medium text-blue-400">Running...</span>
                            <span id="progress-percentage" class="text-sm font-medium text-blue-400">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-400 mt-2">
                            <span id="elapsed-time-text">Elapsed: 0s</span>
                            <span id="eta-text">ETA: N/A</span>
                        </div>
                     </div>
                </div>
                <!-- Results -->
                <div id="results-container" class="card hidden">
                     <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">Simulation Results</h2>
                     <div class="space-y-6">
                        <details id="overall-stats-details" open>
                            <summary>Overall Game Statistics</summary>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                                <div class="md:col-span-2 flex">
                                    <div id="live-deck-display" class="w-1/5 pr-4 overflow-y-auto text-xs hidden"></div>
                                    <div id="live-turn-display" class="flex-grow pr-4 text-xs hidden h-80 overflow-y-auto bg-gray-800 p-2 rounded-md"></div>
                                    <div id="pot-size-chart" class="flex-grow h-80"></div>
                                </div>
                                 <div id="player-pot-history-container" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Player pot history heatmaps go here -->
                                </div>
                                <div class="md:col-span-2 overflow-x-auto pt-4">
                                    <h3 class="text-xl font-bold mb-2 pl-2">Spread Analysis</h3>
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs uppercase bg-gray-700">
                                            <tr>
                                                <th class="px-2 py-2 align-bottom border-r border-gray-600">Spread</th>
                                                <th colspan="5" class="px-2 py-2 text-center border-b border-r border-gray-600">Measured</th>
                                                <th colspan="5" class="px-2 py-2 text-center border-b border-r border-gray-600">Contextual</th>
                                                <th colspan="5" class="px-2 py-2 text-center border-b border-gray-600">Theoretical</th>
                                            </tr>
                                            <tr>
                                                <th class="px-2 py-2 border-r border-gray-600"></th>
                                                <th class="px-2 py-2 text-center">Occur %</th>
                                                <th class="px-2 py-2 text-center">W%</th>
                                                <th class="px-2 py-2 text-center">L%</th>
                                                <th class="px-2 py-2 text-center">DL%</th>
                                                <th class="px-2 py-2 text-center">EV</th>

                                                <th class="px-2 py-2 text-center">Occur %</th>
                                                <th class="px-2 py-2 text-center">W%</th>
                                                <th class="px-2 py-2 text-center">L%</th>
                                                <th class="px-2 py-2 text-center">DL%</th>
                                                <th class="px-2 py-2 text-center">EV</th>

                                                <th class="px-2 py-2 text-center">Occur %</th>
                                                <th class="px-2 py-2 text-center">W%</th>
                                                <th class="px-2 py-2 text-center">L%</th>
                                                <th class="px-2 py-2 text-center">DL%</th>
                                                <th class="px-2 py-2 text-center">EV</th>
                                            </tr>
                                        </thead>
                                        <tbody id="spread-analysis-table">
                                            <!-- Rows will be generated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="game-length-heatmap-container" class="h-96">
                                    <div id="game-length-heatmap" class="h-96"></div>
                                </div>
                                <div id="antes-made-heatmap-container" class="h-96">
                                    <div id="antes-made-heatmap" class="h-96"></div>
                                </div>
                                <div id="shuffles-heatmap-container" class="h-96">
                                    <div id="shuffles-heatmap" class="h-96"></div>
                                </div>
                                <div id="game-time-heatmap-container" class="h-96">
                                    <div id="game-time-heatmap" class="h-96"></div>
                                </div>
                            </div>
                        </details>
                        <details id="player-stats-details">
                            <summary>Player Statistics</summary>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4">
                                <div id="gave-up-heatmap-container" class="h-96 hidden">
                                    <div id="gave-up-heatmap" class="h-96"></div>
                                </div>
                                <div id="player-win-loss-container" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Player heatmaps go here -->
                                </div>
                                <div id="player-bet-amount-container" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Player bet amount heatmaps go here -->
                                </div>
                            </div>
                        </details>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Editor Modal -->
    <div id="player-modal" class="modal-backdrop hidden">
        <div class="card modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4">Add Player</h2>
            <div class="space-y-4">
                <input type="hidden" id="player-id">
                <div>
                    <label for="player-name" class="block font-medium mb-1">Player Name</label>
                    <input type="text" id="player-name" placeholder="e.g., Player 1">
                </div>
                <!-- Financials -->
                <h3 class="font-bold pt-2 border-t border-gray-600">Financials</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-money" class="block font-medium mb-1">Starting Money ($)</label>
                        <input type="number" id="start-money" value="100" step="0.01">
                    </div>
                    <div>
                        <label for="stop-loss" class="block font-medium mb-1">Stop-Loss Threshold ($) (optional)</label>
                        <input type="number" id="stop-loss" placeholder="e.g., -50" step="0.01">
                    </div>
                 </div>
                 <h4 class="font-semibold pt-2">Re-buy Strategy</h4>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="rebuy-strategy" class="block font-medium mb-1">Type</label>
                        <select id="rebuy-strategy">
                            <option value="cover_bet">Cover Bet Needed</option>
                            <option value="fixed_amount">Fixed Amount</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                     <div id="rebuy-amount-container">
                        <label for="buy-in-amount" class="block font-medium mb-1">Re-buy Amount ($)</label>
                        <input type="number" id="buy-in-amount" value="50" min="0.01" step="0.01">
                    </div>
                     <div>
                        <label for="buy-in-count" class="block font-medium mb-1"># of Re-buys</label>
                        <input type="number" id="buy-in-count" value="1" min="0">
                        <label><input type="checkbox" id="buy-in-unlimited" class="w-auto mt-1"> Unlimited</label>
                    </div>
                 </div>

                <!-- Card Counting -->
                <h3 class="font-bold pt-4 border-t border-gray-600">Card Counting Strategy</h3>
                <div>
                    <label for="card-counting" class="block font-medium mb-1">Awareness of remaining cards</label>
                    <select id="card-counting">
                        <option value="none">None (Assumes full deck)</option>
                        <option value="full">Full (Perfect knowledge of discard pile)</option>
                        <option value="custom">Custom (Tracks specific ranks)</option>
                    </select>
                </div>
                <div id="custom-ranks-container" class="hidden">
                    <label for="custom-ranks" class="block font-medium mb-1">Ranks to track (comma-separated: 2-10, J, Q, K, A)</label>
                    <input type="text" id="custom-ranks" placeholder="e.g., A, K, Q">
                </div>

                <!-- Betting Strategy -->
                <h3 class="font-bold pt-4 border-t border-gray-600">Betting Strategy per Spread</h3>
                <p class="text-sm text-gray-400">Define the bet for each possible spread between two cards. Spread 0 is two cards of the same rank (e.g., 5-5), spread 1 is consecutive (e.g., 5-6), up to spread 12 (Ace-2).</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs uppercase bg-gray-700">
                            <tr>
                                <th class="px-4 py-2">Spread</th>
                                <th class="px-4 py-2">Strategy</th>
                                <th class="px-4 py-2">Value</th>
                                <th class="px-2 py-2 text-center">Theo. Occur %</th>
                                <th class="px-2 py-2 text-center">Theo. Win%</th>
                                <th class="px-2 py-2 text-center">Theo. Loss%</th>
                                <th class="px-2 py-2 text-center">Theo. D-Loss%</th>
                                <th class="px-2 py-2 text-center">Theo. EV</th>
                            </tr>
                        </thead>
                        <tbody id="betting-strategy-table">
                            <!-- Rows will be generated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end gap-4 pt-4">
                    <button id="cancel-player-btn" class="btn btn-secondary">Cancel</button>
                    <button id="save-player-btn" class="btn btn-primary">Save Player</button>
                </div>
            </div>
        </div>
    </div>

    <script src="./scripts.js" type="module"></script>

</body>
</html>